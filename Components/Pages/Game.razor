@rendermode InteractiveServer
@page "/Game"
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Processing
@using SlideMasters_BlazorApp.Models
@using System.Timers

<PageTitle>Home</PageTitle>

<h1>Image Viewer</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick='() => LoadImageData("redToji")'>Load Toji Image</button>
    <h4>@secondsRemaining</h4>
</div>

@if (ImageSource != null)
{
    <div>
        <h3>Image Information</h3>
        <p><strong>Path:</strong> @ImageSource</p>
        @if (ImageWidth > 0 && ImageHeight > 0)
        {
            <p><strong>Resolution:</strong> @ImageWidth x @ImageHeight pixels</p>
        }

        @*<div style="display:flex; flex-wrap:wrap; gap: 5px; margin: 5px>*@

        <div style="display: grid; grid-template-columns: repeat(4, 100px); gap: 5px; margin: 5px;">
            @if (GameController.slidingPuzzleBlocks.Count > 0)
            {
                @for (int i = 0; i < GameController.slidingPuzzleBlocks.Count; i++)
                {
                    var block = GameController.slidingPuzzleBlocks[i];
                    <img src = "@block.DataUri" @onclick = "() => OnClickBlock(i)" alt = "Image Block" style = "width: 100px; height: 100px; border: 1px solid black;" />
                    

                }
            }

        </div>
    </div>
}


@code
{
    //main puzzle pieces
    public GameController GameController { get; set; } = new GameController();
    public int emptyBlockIndex = 0;

    //Validate input image
    private string? ImageSource { get; set; }
    private int ImageWidth { get; set; }
    private int ImageHeight { get; set; }

    private ImageSplitter imageSplitter = new ImageSplitter();
    private int gridWidth = 4;
    private int gridHeight = 4;

    private int secondsRemaining { get; set; }
    private Timer? timer { get; set; }

    private void OnClickBlock(int index)
    {
        if (index < GameController.slidingPuzzleBlocks.Count) 
        {
            ImageBlock clickedBlock = GameController.slidingPuzzleBlocks[index];
            // i need to do math raaaaaaa
            // Implement logic to move the clicked block if it's adjacent to the empty space
        }

    }

    private void LoadImageData(string imageName)
    {
        StartTimer();

        ImageSource = $"/Images/Static/{imageName}.jpg";

        try
        {
            // Path to the image file on the server
            var filePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "Images", "Static", $"{imageName}.jpg");

            if (File.Exists(filePath))
            {
                var imageInfo = Image.Identify(filePath);
                if (imageInfo != null)
                {
                    ImageWidth = imageInfo.Width;
                    ImageHeight = imageInfo.Height;
                }

                //We only want to split the image if it exists
                try
                {
                    //Split the image to store

                    //for square boards, the amount of blocks needs to be a perfect square
                    //so, for a 4x4 board, we use 4 as the mod for rows and columns and 4^2 is our total amount of squares
                    //we also need to use the image resolution to properly set the image in the correct coordinate

                    var getBlocks = imageSplitter.SplitImage(filePath, (gridHeight * gridWidth));

                    for (int i = 0; i < getBlocks.Count(); i++)
                    {
                        var block = new ImageBlock(getBlocks[i]) { BoardX = i % gridWidth, BoardY = (int)(i / gridWidth) };
                        GameController.slidingPuzzleBlocks.Add(block);
                    }

                    //Remove the last block to allow an empty image to be added
                    emptyBlockIndex = GameController.slidingPuzzleBlocks.Count - 1;
                    GameController.slidingPuzzleBlocks.RemoveAt(emptyBlockIndex);

                    //Shuffle the existing pieces
                    ImageRandomizer.Shuffle<ImageBlock>(ref GameController.slidingPuzzleBlocks);

                    //Get the empty block and create an Image block from it
                    //It is resized to match the existing puzzle block dimensions
                    var emptyBlock = Image.Load(Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "Images", "Static", "empty_block.png"));
                    emptyBlock.Mutate(context => context.Resize(ImageWidth / gridWidth, ImageHeight / gridHeight));
                    var imgEmptyBlock = new ImageBlock(emptyBlock) { BoardX = (emptyBlockIndex) % gridWidth, BoardY = (int)((emptyBlockIndex) / gridWidth), IsEmptyBlock = true };
                    
                    //Add the empty block to the end
                    GameController.slidingPuzzleBlocks.Add(imgEmptyBlock);


                }
                catch (Exception spl)
                {
                    Console.WriteLine($"Error while splitting image: {spl.Message}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reading image resolution: {ex.Message}");
        }
    }

    private void StartTimer()
    {
        secondsRemaining = 60;
        timer = new Timer(1000);
        timer.Elapsed += OnTimedEvent;
        timer.AutoReset = true;
        timer.Enabled = true;
    }

    private void OnTimedEvent(object sender, ElapsedEventArgs e)
    {
        if (secondsRemaining > 0)
        {
            secondsRemaining--;
            InvokeAsync(StateHasChanged);
        }
        else
        {
            //Loop timer indefinitely until full split of home page and "game" page
            timer?.Stop();
            StartTimer();
        }
    }
}
