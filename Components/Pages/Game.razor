@rendermode InteractiveServer
@page "/Game"
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Processing
@using SlideMasters_BlazorApp.Models
@using System.Timers
@inject IWebHostEnvironment Enviroment
@inject NavigationManager NavigationManager

<PageTitle>Home</PageTitle>

<h1>Image Viewer</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick='() => LoadImageData("redToji")'>Load Toji Image</button>
</div>

@if (hasLoaded)
{
    <h4>@secondsRemaining</h4>
}

@if (ImageSource != null)
{
    <div>
        <h3>Image Information</h3>
        <p><strong>Path:</strong> @ImageSource</p>
        @if (ImageWidth > 0 && ImageHeight > 0)
        {
            <p><strong>Resolution:</strong> @ImageWidth x @ImageHeight pixels</p>
        }

        <div style="display: grid; grid-template-columns: repeat(4, 100px); gap: 5px; margin: 5px;">
            @if (GameController.slidingPuzzleBlocks.Count > 0)
            {
                //Draw puzzle grid
                @for (int i = 0; i < GameController.slidingPuzzleBlocks.Count; i++)
                {
                    var block = GameController.slidingPuzzleBlocks[i];
                    <img src="@block.DataUri" @onclick="() => OnClickBlock(i)" alt="Image Block" style="width: 100px; height: 100px; border: 1px solid black;" />
                }
            }
        </div>
    </div>
}


@code
{

    [Parameter] [SupplyParameterFromQuery] public string? ImagePath { get; set; }

    [Parameter] [SupplyParameterFromQuery] public bool IsTimed { get; set; }

    //main puzzle pieces
    public GameController GameController { get; set; } = new GameController();
    public int emptyBlockIndex = 0;
    public bool hasLoaded = false;
    public bool hasWon = false;

    //Validate input image
    private string? ImageSource { get; set; }
    private int ImageWidth { get; set; }
    private int ImageHeight { get; set; }


    private ImageSplitter imageSplitter = new ImageSplitter();
    private int gridWidth = 4;
    private int gridHeight = 4;

    private int secondsRemaining { get; set; }
    private Timer? timer { get; set; }
    
    private void CheckWinCondition()
    {
        bool win = true;
        for (int j = 0; j < GameController.slidingPuzzleBlocks.Count; j++)
        {
            if (GameController.slidingPuzzleBlocks[j].BoardID != j)
            {
                win = false;
                break;
            }
        }
        hasWon = win;
        
        if (hasWon)
        {
            timer?.Stop();
        }
    }
    

    private void OnClickBlock(int index)
    {
        if (index < GameController.slidingPuzzleBlocks.Count)
        {
            ImageBlock clickedBlock = GameController.slidingPuzzleBlocks[index];

            // Implement logic to move the clicked block if it's adjacent to the empty space
            if (!clickedBlock.IsEmptyBlock)
            {

                //get orthogonal positions
                bool upCoords = FindImageBlock(clickedBlock.BoardX, clickedBlock.BoardY - 1);
                bool downCoords = FindImageBlock(clickedBlock.BoardX, clickedBlock.BoardY + 1);
                bool leftCoords = FindImageBlock(clickedBlock.BoardX - 1, clickedBlock.BoardY);
                bool rightCoords = FindImageBlock(clickedBlock.BoardX + 1, clickedBlock.BoardY);

            }
        }

    }

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(ImagePath))
        {
            ImagePath = "/Images/Static/redToji.jpg"; // Default fallback
        }
        
        LoadImageData(ImagePath);
        
        if (IsTimed)
        {
            StartTimer();
        }
    }

    private void LoadImageData(string imagePath)
    {
        ImageSource = imagePath;
        string physicalPath;

        try
        {
            if (imagePath.StartsWith("http"))
            {
                Console.WriteLine("URL detected. Need to add full functionallity");
                return;
            }
            
            {
                physicalPath = Path.Combine(Enviroment.WebRootPath, imagePath.TrimStart('/'));
            }

            if (File.Exists(physicalPath))
            {
                var imageInfo = Image.Identify(physicalPath);
                if (imageInfo != null)
                {
                    ImageHeight = imageInfo.Height;
                    ImageWidth = imageInfo.Width;
                }

                var getBlocks = imageSplitter.SplitImage(physicalPath, (gridHeight * gridWidth));
                GameController.slidingPuzzleBlocks.Clear();

                for (int i = 0; i < getBlocks.Count(); i++)
                {
                    var block = new ImageBlock(getBlocks[i]) { BoardX = i % gridWidth, BoardY = (int)(i / gridWidth), BoardID = i };
                    GameController.slidingPuzzleBlocks.Add(block);
                }

                //Remove the last block to allow an empty image to be added
                emptyBlockIndex = GameController.slidingPuzzleBlocks.Count - 1;
                GameController.slidingPuzzleBlocks.RemoveAt(emptyBlockIndex);

                //Shuffle the existing pieces
                ImageRandomizer.Shuffle<ImageBlock>(ref GameController.slidingPuzzleBlocks);

                //Get the empty block and create an Image block from it
                //It is resized to match the existing puzzle block dimensions
                var emptyBlock = Image.Load(Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "Images", "Static", "empty_block.png"));
                emptyBlock.Mutate(context => context.Resize(ImageWidth / gridWidth, ImageHeight / gridHeight));
                var imgEmptyBlock = new ImageBlock(emptyBlock) { BoardX = (emptyBlockIndex) % gridWidth, BoardY = (int)((emptyBlockIndex) / gridWidth), IsEmptyBlock = true, BoardID = emptyBlockIndex };

                //Add the empty block to the end
                GameController.slidingPuzzleBlocks.Add(imgEmptyBlock);

                //Puzzle construction is successful, dont allow players to load the image again
                hasLoaded = true;
                StartTimer();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reading image resolution: {ex.Message}");
        }
    }


    private bool FindImageBlock(int boardX, int boardY)
    {
        ImageBlock? imgBlock = GameController.slidingPuzzleBlocks.Find(img => img.BoardX == boardX && img.BoardY == boardY);

        return imgBlock.Equals(null);
    }

    private void StartTimer()
    {
        secondsRemaining = 60;
        timer = new Timer(1000);
        timer.Elapsed += OnTimedEvent;
        timer.AutoReset = true;
        timer.Enabled = true;
    }

    private void OnTimedEvent(object sender, ElapsedEventArgs e)
    {
        if (secondsRemaining > 0)
        {
            secondsRemaining--;
            InvokeAsync(StateHasChanged);
        }
        else
        {
            //Loop timer indefinitely until full split of home page and "game" page
            timer?.Stop();
            StartTimer();
        }
    }
}
