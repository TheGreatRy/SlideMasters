@rendermode InteractiveServer
@page "/"
@using SixLabors.ImageSharp
@using SlideMasters_BlazorApp.Models

<PageTitle>Home</PageTitle>

<h1>Image Viewer</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick='() => LoadImageData("redToji")'>Load Toji Image</button>
</div>

@if (ImageSource != null)
{
    <div>
        <h3>Image Information</h3>
        <p><strong>Path:</strong> @ImageSource</p>
        @if (ImageWidth > 0 && ImageHeight > 0)
        {
            <p><strong>Resolution:</strong> @ImageWidth x @ImageHeight pixels</p>
        }
        <img src="@ImageSource" alt="Selected Image" style="max-width: 100%; height: auto; border: 1px solid #ccc;" />
    </div>
}


@code
{
    //main puzzle pieces
    public List<ImageBlock> slidingPuzzleBlocks = new List<ImageBlock>();

    //Validate input image
    private string? ImageSource { get; set; }
    private int ImageWidth { get; set; }
    private int ImageHeight { get; set; }

    private void LoadImageData(string imageName)
    {
        ImageSource = $"/Images/{imageName}.jpg";

        try
        {
            // Path to the image file on the server
            var filePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "Images", $"{imageName}.jpg");

            if (File.Exists(filePath))
            {
                // Identify image metadata without loading the full image into memory
                var imageInfo = Image.Identify(filePath);
                if (imageInfo != null)
                {
                    ImageWidth = imageInfo.Width;
                    ImageHeight = imageInfo.Height;
                }

                //We only want to split the image if it exists
                try
                {
                    //Split the image to store

                    var imageSplitter = new ImageSplitter();

                    //for square boards, the amount of blocks needs to be a perfect square
                    //so, for a 4x4 board, we use 4 as the mod for rows and columns and 4^2 is our total amount of squares
                    //we also need to use the image resolution to properly set the image in the correct coordinate
                    var getBlocks = imageSplitter.SplitImage(filePath, 16);

                    foreach (Image img in getBlocks)
                    {
                        var block = new ImageBlock(img);
                        slidingPuzzleBlocks.Add(block);
                    }

                }
                catch (Exception spl)
                {
                    Console.WriteLine($"Error while splitting image: {spl.Message}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reading image resolution: {ex.Message}");
        }

        
    }
}
